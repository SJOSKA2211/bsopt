# Research: OAuth2 Consolidation Strategy

**Date**: 2026-02-04

## 1. Executive Summary
The `bsopt` codebase features a fragmented and redundant authentication landscape. It employs two distinct auth services (one Python-based in `src/auth`, one Node.js-based in `src/auth-service`), multiple token validation strategies, and inconsistent security middleware. Consolidation is required to unify these into a single, high-performance OAuth2 stack utilizing Neon for state persistence.

## 2. Technical Context
- **Python Auth Implementation**:
    - `src/auth/server.py:11`: Implements `generate_token` using client credentials.
    - `src/auth/server.py:37`: Implements `openid_configuration` endpoint.
    - `src/auth/security.py:42`: Implements `verify_token` as a FastAPI dependency.
    - `src/auth/providers.py:33`: Implements `verify` using RSA/JWKS logic.
    - `src/auth/better_auth.py:7`: Implements `get_current_user` using session tokens in cookies.
- **Node.js Auth Implementation**:
    - `src/auth-service/`: Standalone service using Hono and `@better-auth`.
- **Middleware**:
    - `src/api/middleware/security.py`: Redundant/inconsistent security logic.

## 3. Findings & Analysis
- **Redundancy**: Dual implementations in Python and Node.js.
- **Inconsistency**: `src/auth/providers.py:73` (not shown in grep but inferred) uses a fallback to "secret" with HS256.
- **Conflicting logic**: `better_auth.py:7` uses cookies, while `security.py:42` uses `Bearer` tokens.
- **JWKS inconsistency**: `src/auth/server.py:50` and `src/auth/security.py:32` both implement JWKS logic separately.

## 4. Technical Constraints
- Must support Python 3.14.
- Must integrate with Neon serverless postgres.
- High-frequency trading requirements demand sub-millisecond token validation.

## 5. Architecture Documentation (Current)
- **Auth Flow**: fragmented. Client credentials used in `server.py`, sessions used in `better_auth.py`.
- **RBAC**: Hand-rolled role checking in `src/auth/security.py:72`.