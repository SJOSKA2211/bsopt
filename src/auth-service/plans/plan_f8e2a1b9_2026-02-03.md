# Plan: Debugging and Coverage Improvement for Auth Service (Ticket f8e2a1b9)

## Overview
This plan details the steps to resolve critical issues identified for ticket `f8e2a1b9`: "Research: Identify Areas for Debugging and Coverage Improvement". The goal is to address routing failures, missing Python test dependencies, and lack of coverage data by implementing fixes and establishing a baseline for coverage analysis.

## Current State Analysis
- **Routing Issues**: POST requests to `/api/auth/login` return 404 (ref: `testsprite-mcp-test-report.md` lines 32-34, `TC002_authentication_endpoint_delegates_requests_to_betterauth.py` lines 45-46). This impacts tests `TC002`, `TC005`, `TC007`.
- **Missing Python Dependencies**: `psycopg2` and `jsonschema` are missing in the test environment (ref: `testsprite-mcp-test-report.md` lines 45-46, 58-59), blocking `TC003` and `TC004`.
- **Error Handling**: Basic error handling passes (`TC006` passed, ref: `testsprite-mcp-test-report.md` line 79).
- **Performance Test**: `TC007` failed due to routing issues (`testsprite-mcp-test-report.md` lines 93-94).
- **Coverage Goal**: Target is >= 96% test coverage, stated in PRDs and tickets. Current metrics are unknown.
- **Test Framework**: Testsprite orchestrates Python tests in `/home/kamau/bsopt/src/auth-service/testsprite_tests/`.
- **Research Document**: `/home/kamau/bsopt/src/auth-service/research/f8e2a1b9_research_2026-02-03.md` contains detailed findings.

## Implementation Approach
The plan is structured in phases: first, resolve foundational routing and environment issues; second, debug existing tests; third, establish and work towards the coverage goal; finally, document findings.

## Phase 1: Fix Routing and Install Test Dependencies
### Overview
Address the critical routing failure for `/api/auth/login` and ensure the necessary Python dependencies are available for the test environment. This is foundational for all subsequent testing and debugging.
### Changes Required:
#### 1. Fix `/api/auth/login` Routing Issue
**File**: `src/index.ts` (Presumed investigation needed)
**Changes**: Analyze route configuration in `src/index.ts` and delegation logic in `src/auth.ts` to correct the handling of `/api/auth/login` POST requests. The goal is to return 200 OK instead of 404.
```typescript
// src/index.ts or src/auth.ts
// Investigate and modify route definitions to ensure '/api/auth/login' is correctly handled.
// Example: If using Hono, ensure the router correctly matches and forwards requests.
```
**Success Criteria**:
#### Automated:
- [ ] `TC002_authentication_endpoint_delegates_requests_to_betterauth.py` passes for POST `/api/auth/login`.
- [ ] `TC005_authentication_tokens_are_persisted_and_validated.py` passes.
- [ ] `TC007_performance_under_expected_load.py` passes (dependent on login endpoint).
#### Manual:
- [ ] Execute a POST request to `/api/auth/login` and verify a 200 OK response.

#### 2. Install Missing Python Test Dependencies
**File**: Test environment setup (e.g., `testsprite_tests/requirements.txt` or Dockerfile - investigate existence)
**Changes**: Identify how the Python test environment is configured. If a `requirements.txt` or `Dockerfile` exists in `testsprite_tests/`, add `psycopg2-binary` and `jsonschema`. If no setup mechanism is explicit, document the need for manual installation for the test runner.
```bash
# Example command if managing Python dependencies via pip:
# pip install psycopg2-binary jsonschema
```
**Success Criteria**:
#### Automated:
- [ ] `TC003_database_connectivity_on_startup.py` executes without `ModuleNotFoundError: No module named 'psycopg2'`.
- [ ] `TC004_openapi_documentation_compliance.py` executes without `ModuleNotFoundError: No module named 'jsonschema'`.
#### Manual:
- [ ] Confirm Python test environment is correctly set up with all required packages.

## Phase 2: Debug and Fix Failing Tests
### Overview
Address the failing Python tests identified by Testsprite, specifically those related to routing, dependencies, and error handling.
### Changes Required:
#### 1. Debug and Fix Routing-Related Test Failures (`TC002`, `TC005`, `TC007`)
**File**: `src/index.ts`, `src/auth.ts`, and potentially `testsprite_tests/` Python test files.
**Changes**: After Phase 1 fixes, re-run these tests. If failures persist, debug the service's routing logic in `src/index.ts` and `src/auth.ts`. Potentially adjust test assertions if intended behavior differs from test expectations.
```typescript
// src/index.ts or src/auth.ts
// Debug routing logic: analyze Hono setup and better-auth delegation.
```
**Success Criteria**:
#### Automated:
- [ ] `TC002`, `TC005`, `TC007` tests pass.
#### Manual:
- [ ] Verify `/api/auth/login` and other `/api/auth/*` endpoints route correctly and return 200 OK for valid requests.

#### 2. Debug and Fix Dependency-Related Test Failures (`TC003`, `TC004`)
**File**: Test environment setup (e.g., `requirements.txt`, `Dockerfile` in `testsprite_tests/`) and potentially `src/db.ts`.
**Changes**: Confirm Python dependencies are correctly installed. Debug `src/db.ts` if `psycopg2` installation issues are tied to service configuration. Re-run `TC003` and `TC004`.
```python
# Verify test environment dependency installation.
# Ensure PostgreSQL connection details are correctly configured for TC003.
```
**Success Criteria**:
#### Automated:
- [ ] `TC003_database_connectivity_on_startup.py` passes.
- [ ] `TC004_openapi_documentation_compliance.py` passes.
#### Manual:
- [ ] Confirm Python test environment is stable and functional.

## Phase 3: Establish and Measure Coverage
### Overview
Determine current test coverage metrics and identify specific areas requiring new tests to meet the >= 96% goal.
### Changes Required:
#### 1. Configure and Run Coverage Tool
**Command**: Determine the command to run Testsprite with coverage enabled. Consult `testsprite_backend_test_plan.json` or project documentation.
**Changes**: Execute the coverage command.
```bash
# Example: Assuming a command like this exists:
# python -m testsprite --coverage ...
# Or if coverage is integrated into another command:
# testsprite --run-all --coverage ...
```
**Success Criteria**:
#### Automated:
- [ ] Coverage report generated successfully (e.g., HTML, JSON, console output).
#### Manual:
- [ ] Review the coverage report to identify files/modules with coverage below 96%.

#### 2. Implement New Tests for Low-Coverage Areas
**File**: `src/auth.ts`, `src/db.ts`, `src/index.ts`, and new Python test files in `testsprite_tests/`.
**Changes**: Write new unit, integration, or end-to-end tests targeting identified low-coverage areas. Prioritize critical logic and error paths.
```typescript
// Add new tests in src/*.ts and corresponding Python tests in testsprite_tests/
```
**Success Criteria**:
#### Automated:
- [ ] All existing tests pass.
- [ ] Newly added tests pass.
- [ ] Final coverage report shows >= 96% for targeted modules.
#### Manual:
- [ ] Review new tests for comprehensiveness and best practices.

## Phase 4: Document and Finalize
### Overview
Document the fixes, changes, and coverage improvements made.
### Changes Required:
#### 1. Document Bug Fixes and Coverage Strategies
**File**: `/home/kamau/bsopt/src/auth-service/documentation/debugging_coverage_report.md` (or similar location)
**Changes**: Create a clear document summarizing fixed bugs, reasons for fixes, and strategies used to achieve >= 96% coverage.
```markdown
# Auth Service Debugging and Coverage Report

## 1. Bugs Fixed
- [Description of bug 1, fix details, file:line references]
- [Description of bug 2...]

## 2. Coverage Improvement
- [How >=96% coverage was achieved. Areas targeted.]
- [Strategies for maintaining coverage.]
```
**Success Criteria**:
#### Manual:
- [ ] Documentation is clear, concise, and accurate.
- [ ] Documentation is stored in an accessible location.

## Next Step
**Verify Architecture**: Call `activate_skill("plan-reviewer")`.
