# Research: Fix Environment and Baseline Coverage

**Date**: 2026-02-04

## 1. Executive Summary
The test suite fails to initialize because of Pydantic validation errors in the `src.config.Settings` class. This is caused by top-level imports in `tests/conftest.py` that trigger the instantiation of `Settings` before the test environment (mocks) can be established.

## 2. Technical Context
- **Affected File**: `src/config.py:119` -> `settings = Settings()`
- **Triggering File**: `tests/conftest.py:102` -> `from src.database.models import User, APIKey`
- **Dependency Chain**:
    1. `pytest` loads `tests/conftest.py`.
    2. `tests/conftest.py` line 102 imports `src.database.models`.
    3. `src.database.models` (or `src.database.__init__.py`) imports `src.config.settings`.
    4. `src.config.settings` attempts to instantiate `Settings()`.
    5. `Settings()` fails validation because `REDIS_URL` and `JWT_SECRET` are missing from the environment.

## 3. Findings & Analysis
- **Validation Errors**: The `Settings` class uses `Field(validation_alias=...)` without defaults for `DATABASE_URL`, `REDIS_URL`, and `JWT_SECRET`.
- **Top-Level Imports**: `tests/conftest.py` contains several top-level imports that depend on `src.config.settings`. These include `src.database.models` and others.
- **Mocking Failure**: The `pytest_configure` hook in `tests/conftest.py` attempts to mock `src.config.Settings`, but this happens too late because the module-level imports have already triggered the real instantiation.
- **Ray Initialization**: `src/workers/math_worker.py` calls `RayOrchestrator.init()` at the top level. Since `ray` is not mocked in `tests/conftest.py`, this attempts a real Ray initialization during test collection, which fails in the test environment.
- **CircuitBreaker Import Error**: `src/workers/webhook_worker.py` attempts to import `CircuitBreaker` from `src.webhooks.dispatcher`, which does not exist in the target module.
- **Event Loop Errors**: Multiple tests fail with `RuntimeError: There is no current event loop in thread 'MainThread'`, indicating issues with `asyncio` lifecycle management in the test suite under Python 3.14.

## 4. Technical Constraints
- `pydantic-settings` enforces validation at instantiation.
- `conftest.py` module-level code runs when the module is imported by `pytest`.
- Ray requires a cluster or local instance unless mocked.

## 5. Architecture Documentation
- The project uses `pydantic-settings` for centralized configuration.
- It relies on environment variables or a `.env` file for core service URLs.
- The `tests/conftest.py` uses a "MonkeyPatch" approach in `pytest_configure` to mock the configuration, which is fundamentally flawed if dependencies are imported at the top level.
