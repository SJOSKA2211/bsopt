# Fix Environment and Baseline Coverage Implementation Plan

## Overview
The goal is to resolve the Pydantic validation errors preventing the test suite from running and establish a baseline coverage report for the project.

## Current State Analysis
- `src.config.Settings` requires `REDIS_URL` and `JWT_SECRET` but they are missing from the environment during test initialization.
- Top-level imports in `tests/conftest.py` (e.g. line 102) trigger `Settings()` instantiation before `pytest_configure` can apply mocks.
- Baseline coverage is reported as 2.6%, but this is likely due to incomplete test runs.

## Implementation Approach
We will provide dummy environment variables during the `pytest` execution to satisfy Pydantic validation. Additionally, we will update `tests/conftest.py` to mock `ray` and fix the event loop lifecycle. We will also resolve the broken import in `webhook_worker.py`.

## Phase 1: Environment & Code Fixes
### Overview
Resolve collection errors by fixing imports and mocking heavy dependencies.

### Changes Required:
#### 1. tests/conftest.py
**Changes**: Add `ray` to the mock list and provide a session-scoped `event_loop` fixture.
```python
# Add to mod list
for mod in [..., "ray", "ray.tune", "ray.air", "ray.train"]:
    sys.modules[mod] = VersionedMock(_mock_name=mod)
```

#### 2. src/workers/webhook_worker.py
**Changes**: Fix broken `CircuitBreaker` import (Done).

### Success Criteria:
#### Automated:
- [ ] `pytest --collect-only` passes without 48 errors.

## Phase 2: Baseline Coverage Run
### Overview
Execute the test suite with required environment variables and generate a full coverage report.

### Changes Required:
#### 1. Shell Command
**Changes**: Prefix `pytest` with required environment variables.
```bash
export DATABASE_URL="postgresql://admin:password@localhost:5432/bsopt"
export REDIS_URL="redis://localhost:6379/0"
export JWT_SECRET="test-secret-for-hmac"
./.venv/bin/python -m pytest --cov=src --cov-report=xml --cov-report=term-missing
```

### Success Criteria:
#### Automated:
- [ ] `pytest` exit code is 0 or 1 (tests run, some might fail, but no collection errors).
- [ ] `coverage.xml` is generated and contains data for the `src/` directory.
#### Manual:
- [ ] Verify `coverage.xml` exists and has a line-rate > 0.026.

**Implementation Note**: If tests still fail due to other missing variables, we will iterate and add them to the export list.
